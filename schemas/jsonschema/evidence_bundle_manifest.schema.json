{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://standard.aimoaas.com/schemas/evidence_bundle_manifest.schema.json",
  "title": "AIMO Evidence Bundle Manifest Schema",
  "description": "Schema for Evidence Bundle manifest.json. Root descriptor with object_index, payload_index, hash_chain, and signing. v0.1 normative.",
  "type": "object",
  "required": [
    "bundle_id",
    "bundle_version",
    "created_at",
    "scope_ref",
    "object_index",
    "payload_index",
    "hash_chain",
    "signing"
  ],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema."
    },
    "bundle_id": {
      "type": "string",
      "description": "Unique identifier for this bundle (UUID).",
      "format": "uuid"
    },
    "bundle_version": {
      "type": "string",
      "description": "Version of the bundle (SemVer).",
      "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.-]+)?(\\+[a-zA-Z0-9.-]+)?$"
    },
    "created_at": {
      "type": "string",
      "description": "Creation timestamp (ISO 8601 date-time).",
      "format": "date-time"
    },
    "scope_ref": {
      "type": "string",
      "description": "Scope reference (e.g. SC-001).",
      "pattern": "^SC-[A-Za-z0-9-]+$"
    },
    "object_index": {
      "type": "array",
      "description": "List of enumerated objects (id, type, path, sha256). Paths MUST be relative, MUST NOT contain ../ or start with /. Paths MUST remain within the Evidence Bundle root; validators MUST reject paths that escape the bundle root.",
      "items": {
        "type": "object",
        "required": ["id", "type", "path", "sha256"],
        "additionalProperties": false,
        "properties": {
          "id": { "type": "string" },
          "type": { "type": "string" },
          "path": {
            "type": "string",
            "description": "Relative path within bundle root; MUST NOT contain ../ (path traversal prevention) or start with /.",
            "pattern": "^(?!\\/)(?!.*\\.\\./).*$"
          },
          "sha256": {
            "type": "string",
            "description": "SHA-256 hash (64 lowercase hex).",
            "pattern": "^[a-f0-9]{64}$"
          }
        }
      }
    },
    "payload_index": {
      "type": "array",
      "description": "List of payloads (logical_id, path, sha256, mime, size). Paths MUST be relative, MUST NOT contain ../ or start with /. Paths MUST remain within the Evidence Bundle root; validators MUST reject paths that escape the bundle root.",
      "items": {
        "type": "object",
        "required": ["logical_id", "path", "sha256", "mime", "size"],
        "additionalProperties": false,
        "properties": {
          "logical_id": { "type": "string" },
          "path": {
            "type": "string",
            "description": "Relative path within bundle root; MUST NOT contain ../ or start with /.",
            "pattern": "^(?!\\/)(?!.*\\.\\./).*$"
          },
          "sha256": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$"
          },
          "mime": { "type": "string" },
          "size": { "type": "integer", "minimum": 0 }
        }
      }
    },
    "hash_chain": {
      "type": "object",
      "description": "Hash chain head and algorithm. v0.1 normative: algorithm, head, path (under hashes/), and covers (v0.1 MUST include manifest.json and objects/index.json).",
      "required": ["algorithm", "head", "path", "covers"],
      "additionalProperties": true,
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["sha256", "merkle"],
          "description": "Hash chain algorithm."
        },
        "head": {
          "type": "string",
          "description": "Chain head (64 lowercase hex for sha256).",
          "pattern": "^[a-f0-9]{64}$"
        },
        "path": {
          "type": "string",
          "description": "Relative path under hashes/; MUST NOT contain ../ or start with /.",
          "pattern": "^(?!\\/)(?!.*\\.\\./).*$"
        },
        "covers": {
          "type": "array",
          "description": "List of bundle paths covered by this chain. v0.1 MUST include manifest.json and objects/index.json.",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^(?!\\/)(?!.*\\.\\./).*$"
          }
        }
      }
    },
    "signing": {
      "type": "object",
      "description": "Signing metadata. v0.1 normative: signatures array with explicit reference (path, targets, algorithm). v0.1.1 adds optional metadata for verification (signer_identity, verification_command, etc.). Cryptographic verification is out of scope until v0.2.",
      "required": ["signatures"],
      "additionalProperties": true,
      "properties": {
        "signatures": {
          "type": "array",
          "description": "List of signature entries. Each entry MUST reference a file under signatures/ and its targets. v0.1 MUST include at least one signature whose targets include manifest.json.",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["signature_id", "path", "targets", "algorithm"],
            "additionalProperties": true,
            "properties": {
              "signature_id": {
                "type": "string",
                "description": "Unique identifier for this signature (e.g. SIG-001 or UUID)."
              },
              "path": {
                "type": "string",
                "description": "Relative path under signatures/ (resolved as bundle_root/signatures/<path>). MUST NOT contain .. or start with /. Path traversal is forbidden.",
                "minLength": 1,
                "pattern": "^(?!\\/)(?!.*\\.\\.).+$"
              },
              "targets": {
                "type": "array",
                "description": "Bundle paths that this signature covers. v0.1 normative: at least one signature in the bundle MUST include manifest.json in targets (enforced by validator).",
                "minItems": 1,
                "items": {
                  "type": "string",
                  "pattern": "^(?!\\/)(?!.*\\.\\./).*$"
                }
              },
              "algorithm": {
                "type": "string",
                "enum": ["ed25519", "rsa-pss", "ecdsa", "unspecified"],
                "description": "Signature algorithm. v0.1 allows unspecified for future extension."
              },
              "created_at": {
                "type": "string",
                "format": "date-time",
                "description": "When the signature was created (MAY)."
              },
              "signer_identity": {
                "type": "string",
                "description": "v0.1.1 RECOMMENDED: Identity of the signer (e.g. PGP fingerprint, did:key). Enables third-party re-performance of verification. Cryptographic verification is out of scope until v0.2."
              },
              "signed_at": {
                "type": "string",
                "format": "date-time",
                "description": "v0.1.1 RECOMMENDED: When the signature was applied (ISO 8601)."
              },
              "verification_command": {
                "type": "string",
                "description": "v0.1.1 RECOMMENDED: Example CLI command for an auditor to re-perform verification (e.g. aimo verify --pubkey ...). Verification execution is out of scope until v0.2."
              },
              "canonicalization": {
                "type": "string",
                "enum": ["rfc8785_json", "cbor", "unspecified"],
                "description": "v0.1.1 RECOMMENDED: How the signed payload was canonicalized (e.g. RFC 8785 JSON). Enables reproducible verification in v0.2."
              }
            }
          }
        }
      }
    },
    "extensions": {
      "type": "object",
      "description": "Reserved for future extensions.",
      "additionalProperties": true
    }
  }
}
