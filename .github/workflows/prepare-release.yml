name: prepare-release

# Prepare Release workflow - automatically updates version references and creates a PR
# This is the FIRST step of a two-step release process:
#   1. Run this workflow to create a PR with version updates
#   2. After PR is merged, push a vX.Y.Z tag to trigger the release workflow
#
# See README.md for the complete release process

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version number (e.g., 0.1.8). Do NOT include "v" prefix.'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version input
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 0.1.8)"
            exit 1
          fi
          echo "Version validated: $VERSION"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bump version references
        id: bump
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "=== Bumping version references to $VERSION ==="
          python tooling/release/bump_release_references.py --version "$VERSION"

      - name: Verify with consistency check
        env:
          RELEASE_TAG: v${{ github.event.inputs.version }}
        run: |
          echo "=== Verifying consistency after bump ==="
          python tooling/checks/check_release_consistency.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/release-v${{ github.event.inputs.version }}
          delete-branch: true
          commit-message: "chore(release): bump references to v${{ github.event.inputs.version }}"
          title: "chore(release): v${{ github.event.inputs.version }} references"
          body: |
            ## Release Preparation: v${{ github.event.inputs.version }}

            This PR was automatically created by the `prepare-release` workflow.

            ### Changes
            - Updated **Versions** pages (EN/JA) with new version
            - Updated **How to Cite** pages (EN/JA) with new version
            - Updated **CITATION.cff** with new version and date

            ### Next Steps
            After merging this PR:
            1. Create and push the release tag:
               ```bash
               git tag v${{ github.event.inputs.version }}
               git push origin v${{ github.event.inputs.version }}
               ```
            2. The `release` workflow will automatically:
               - Run consistency checks
               - Build and deploy docs via mike
               - Create GitHub Release with assets
               - Generate attestations

            ### Verification
            - [x] `bump_release_references.py` completed successfully
            - [x] `check_release_consistency.py` passed
          labels: |
            release
            automated

      - name: Summary
        run: |
          echo "## Prepare Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: v${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A PR has been created with the version reference updates." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. Create and push tag: \`git tag v${{ github.event.inputs.version }} && git push origin v${{ github.event.inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
