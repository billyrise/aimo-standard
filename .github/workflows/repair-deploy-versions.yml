# Re-deploy an existing version from main (repair deploy)
# Use only for critical fixes (e.g. legal/trademark content, AIMO abbreviation)
# that must appear in already-released version URLs. See VERSIONING.md.
# Does NOT update /latest/ or create a new GitHub Release.

name: repair-deploy-versions

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to re-deploy from main (overwrites existing content)'
        required: true
        type: choice
        options:
          - '0.1.0'
          - '0.1.1'
          - '0.1.2'
        default: '0.1.2'
      dry_run:
        description: 'Dry run - build only, do not push to gh-pages'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  repair-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            tooling/requirements.txt

      - name: Install system deps for WeasyPrint (optional for doc build)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 libpangocairo-1.0-0 libcairo2 libgdk-pixbuf2.0-0 \
            fonts-noto-cjk fonts-noto-core fonts-noto-color-emoji || true

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install -r tooling/requirements.txt 2>/dev/null || true

      - name: Generate llms-full.txt (all languages)
        run: |
          echo "=== Generating llms-full.txt for all 10 languages ==="
          python tooling/build_llms_txt.py --all-langs

      - name: Build documentation
        run: python -m mkdocs build --strict

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Re-deploy version to gh-pages (overwrite existing)
        if: ${{ inputs.dry_run == false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          
          echo "=== Re-deploying version $VERSION from main ==="
          echo "This will OVERWRITE the content at /$VERSION/ with the current main branch build."
          echo ""
          
          git fetch origin gh-pages:gh-pages 2>/dev/null || {
            echo "ERROR: Could not fetch gh-pages branch"
            exit 1
          }
          
          # Deploy current build to the version directory (mike overwrites if exists)
          mike deploy --push "$VERSION"
          
          echo ""
          echo "=== Updating root SEO files from /$VERSION/ ==="
          git checkout gh-pages
          # Refresh root robots.txt, sitemap.xml, llms.txt, llms-full.txt from deployed version
          cat > robots.txt << 'ROBOTS_EOF'
          # AIMO Standard robots.txt
          # Canonical site: https://standard.aimoaas.com/
          # Production is fully crawlable; only /dev/ (preview) is disallowed. No global crawler block.
          
          User-agent: *
          Allow: /
          Allow: /latest/
          
          # Disallow dev preview only (unreleased content — not for audit citation)
          Disallow: /dev/
          
          # AI training and retrieval crawlers — explicitly welcome
          # AIMO Standard is Apache-2.0 licensed and intended for AI governance knowledge bases.
          User-agent: GPTBot
          Allow: /
          
          User-agent: ChatGPT-User
          Allow: /
          
          User-agent: OAI-SearchBot
          Allow: /
          
          User-agent: ClaudeBot
          Allow: /
          
          User-agent: anthropic-ai
          Allow: /
          
          User-agent: Google-Extended
          Allow: /
          
          User-agent: PerplexityBot
          Allow: /
          
          User-agent: Meta-ExternalAgent
          Allow: /
          
          User-agent: Amazonbot
          Allow: /
          
          User-agent: Applebot-Extended
          Allow: /
          
          User-agent: CCBot
          Allow: /
          
          User-agent: cohere-ai
          Allow: /
          
          # Sitemap location
          Sitemap: https://standard.aimoaas.com/sitemap.xml
          ROBOTS_EOF
          sed -i.bak 's/^          //' robots.txt && rm -f robots.txt.bak
          if [ -f "${VERSION}/sitemap.xml" ]; then cp "${VERSION}/sitemap.xml" sitemap.xml; fi
          if [ -f "${VERSION}/llms.txt" ]; then cp "${VERSION}/llms.txt" llms.txt; fi
          if [ -f "${VERSION}/llms-full.txt" ]; then cp "${VERSION}/llms-full.txt" llms-full.txt; fi
          git add robots.txt sitemap.xml llms.txt llms-full.txt 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(pages): refresh root SEO files from $VERSION (repair deploy)"
            git push origin gh-pages
            echo "Root SEO files updated."
          fi
          git checkout main
          
          echo ""
          echo "=== Done ==="
          echo "Version /$VERSION/ has been updated with content from main."
          echo "Root SEO files (robots.txt, sitemap.xml, llms.txt, llms-full.txt) refreshed from /$VERSION/."
          echo "/latest/ was NOT changed."
          echo ""
          mike list

      - name: Dry run notice
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "=== DRY RUN ==="
          echo "Build succeeded. No deploy was performed."
          echo ""
          echo "To re-deploy version ${{ inputs.version }} for real, run this workflow again with dry_run=false."

      - name: Summary
        run: |
          echo "## Repair Deploy (re-deploy existing version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | main branch |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "**Status:** Dry run - build OK, no deploy" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Deployed main content to /${{ inputs.version }}/" >> $GITHUB_STEP_SUMMARY
          fi
